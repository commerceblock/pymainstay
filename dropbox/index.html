<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta charset="utf-8"/>
  <title>Mainstay to Dropbox</title>
  <link rel="stylesheet" type="text/css" href="style.css"/>
  <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="1wgf9qlosdu2r6t"/>
  <script type="text/javascript" src="https://brython.info/src/brython.js"/>
  <script type="text/javascript" src="https://brython.info/src/brython_stdlib.js"/>

  <script type="text/python">
  #<![CDATA[
    
    from browser import window, document, ajax
    from browser.html import maketag
    from hashlib import sha256
    import json
    
    tr = maketag('tr')
    td = maketag('td')
    progress = maketag('progress')
    label = maketag('label')
    form_input = maketag('input')
    
    '''
    attest_file_list = None
    downloads_pending = 0
    digest = {}
    
    def dropbox_files_accept(files, something):
        global attest_file_list, downloads_pending, digest

        document['dropbox_button_container'].clear()

        attest_file_list = files
        attest_file_table = document['attest_file_table']
        attest_file_table.clear()

        downloads_pending = len(files)
        digest = {}

        for n, f in enumerate(sorted(files, key=(lambda x: x.name))):
            print(dir(f))
            download_name = 'download_' + str(n)
            progress_name = 'progress_' + str(n)
            attest_file_table <= tr(td(f.name) + td(label("downloads progress", **{'for':progress_name}) + progress(id=progress_name, value='0', max='100'), id=download_name))
            
            digest[f.name] = sha256()

            progress_callback = (lambda progress_name: (lambda src: download_progress(progress_name, src)))(progress_name)
            downloaded_callback = (lambda download_name, progress_name, file_name: (lambda src: downloaded(download_name, progress_name, file_name, src)))(download_name, progress_name, f.name)
            #interactive_callback = (lambda file_name: (lambda src: download_interactive(file_name, src)))(f.name)
            
            ajax.get(f.link, blocking=False, mode='binary', oncomplete=downloaded_callback, onprogress=progress_callback)
    
    def download_interactive(file_name, src):
        digest[file_name].update(src.read())
    
    def download_progress(progress_name, src):
        try:
            document[progress_name].value = src.loaded / src.total * 100
        except (AttributeError, ZeroDivisionError):
            pass
    
    def downloaded(download_name, progress_name, file_name, src):
        document[progress_name].value = 100
        def showhash():
            global downloads_pending
            digest[file_name].update(src.read())
            document[download_name].clear()
            digest[file_name] = digest[file_name].hexdigest()
            document[download_name] <= digest[file_name]
            downloads_pending -= 1
            if downloads_pending == 0:
                window.setTimeout(all_downloads_finished)
        window.setTimeout(showhash)
    
    def all_downloads_finished():
        preimage = bytes.fromhex(''.join([digest[_file_name] for _file_name in sorted(digest.keys())]))
        commitment = sha256(sha256(preimage).digest()).digest()
        document['commitment'].value = commitment.hex()

    #dropbox_button_options = { 'success': dropbox_files_accept, 'linkType': 'direct', 'multiselect': True }
    #dropbox_button = window.Dropbox.createChooseButton(dropbox_button_options)
    #document.getElementById("dropbox_button_container").appendChild(dropbox_button)
    

    def dropbox_files_hashes(files, something):
        for n, f in enumerate(sorted(files, key=(lambda x: x.name))):
            get_metadata = (lambda n: lambda *x: metadata_received(*x))(n)
            request = ajax.ajax()
            request.open('POST', 'https://api.dropboxapi.com/2/files/get_metadata', False)
            request.set_header("Authorization", f"Bearer {bearer}")
            request.set_header("Content-Type", "application/json")
            request.bind('complete', get_metadata)
            request.send({ "path": f"id:{f.id}" })
            #ajax.post('https://api.dropboxapi.com/2/files/get_metadata', blocking=False, headers={"Authorization":"Bearer 1wgf9qlosdu2r6t", "Content-Type": "application/json"}, data={ "path": f"id:{f.id}" }, oncomplete=get_metadata)

    def metadata_received(*args):
        for x in args:
            print(x)
    '''
    
    def attest(event):
        if downloads_pending:
            window.alert("still downloading")
            return
        ajax.post('/attest', blocking=False, data={'commitment': document['commitment'].value, 'slot': document['slot'].value, 'api_token': document['api_token'].value}, oncomplete=attested)
    
    def attested(src):
        window.alert(src.read())
    
    def verify(event):
        if downloads_pending:
            window.alert("still downloading")
            return
        ajax.post('/verify', blocking=False, data={'commitment': document['commitment'].value, 'slot': document['slot'].value, 'api_token': document['api_token'].value}, oncomplete=attested)
    
    def verified(src):
        window.alert(src.read())
    
    def create_mainstay_folder(event):
        request = ajax.ajax()
        request.open('POST', 'https://api.dropboxapi.com/2/files/create_folder_v2', False)
        request.set_header("Authorization", f"Bearer {bearer}")
        request.set_header("Content-Type", "application/json")
        request.bind('complete', download_msc_info)
        request.send(json.dumps({ \
            "path": "/Mainstay", \
            "autorename": False, \
        }))
        # goto download_msc_info
    
    def download_msc_info(req):
        if not (req.status == 200 or req.status == 0): return
        ajax.post('/info', blocking=False, data={'slot': document['slot'].value, 'api_token': document['api_token'].value}, oncomplete=save_msc_info)
        # goto save_msc_info
    
    def save_msc_info(src):
        info = src.read()

        request = ajax.ajax()
        request.open('POST', 'https://content.dropboxapi.com/2/files/upload', False)
        request.set_header("Authorization", f"Bearer {bearer}")
        request.set_header("Content-Type", "application/octet-stream")
        request.set_header('Dropbox-API-Arg', json.dumps({ \
            "path": "/Mainstay/info.txt", \
            "mode": "add", \
            "autorename": False, \
            "mute": False, \
            "strict_conflict": False \
        }))
        #request.bind('complete', lambda event: None)
        request.send(info)
    

    def fetch(event):
        commitment = document['commitment'].value
        slot = document['slot'].value
        ajax.post('/fetch', blocking=False, data={'commitment': commitment, 'slot': slot, 'api_token': document['api_token'].value}, oncomplete=lambda src: fetched(src, slot, commitment))
    
    def fetched(src, slot, commitment):
        proofseq = src.read()

        request = ajax.ajax()
        request.open('POST', 'https://content.dropboxapi.com/2/files/upload', False)
        request.set_header("Authorization", f"Bearer {bearer}")
        request.set_header("Content-Type", "application/octet-stream")
        request.set_header('Dropbox-API-Arg', json.dumps({ \
            "path": f"/Mainstay/{slot}_{commitment}.json", \
            "mode": "add", \
            "autorename": False, \
            "mute": False, \
            "strict_conflict": False \
        }))
        #request.bind('complete', lambda event: None)
        request.send(proofseq)
    
    downloads_pending = 1
    
    def get_file_list():
        request = ajax.ajax()
        request.open('POST', 'https://api.dropboxapi.com/2/files/list_folder', False)
        request.set_header("Authorization", f"Bearer {bearer}")
        request.set_header("Content-Type", "application/json")
        request.bind('complete', got_file_list)
        request.send(json.dumps({ \
            "path": "", \
            "recursive": True, \
            "include_media_info": False, \
            "include_deleted": False, \
            "include_has_explicit_shared_members": True, \
            "include_mounted_folders": True, \
            "include_non_downloadable_files": True \
        }))
    
    def got_file_list(req):
        global file_hashes, downloads_pending
        file_hashes = {}
        if not (req.status == 200 or req.status == 0): return
        result = json.loads(req.text)

        def path_display(f):
            return f['path_display'][1:]
        def content_hash(f):
            return f['content_hash']

        hash_list = []
        for n, f in enumerate(_x for _x in sorted(result['entries'], key=path_display) if _x['.tag'] == 'file'):
            file_path = path_display(f)
            if file_path.startswith('Mainstay/'): continue
            box_id = 'file_' + str(n)
            value = content_hash(f)
            file_hashes[box_id] = value
            checkbox = form_input(**{'type':'checkbox', 'name':box_id, 'id':box_id, 'checked':'1'})
            checkbox.bind('click', toggle_selection)
            document['attest_file_table'] <= tr(td(label(file_path, **{'class':'checkbox', 'for':box_id}) + checkbox) + td(file_path) + td(value))
            hash_list.append(bytes().fromhex(value))
        preimage = bytes().join(hash_list)
        commitment = sha256(sha256(preimage).digest()).digest()
        document['commitment'].value = commitment.hex()
        downloads_pending = 0

    file_hashes = {}
    
    def toggle_selection(event):
        hash_list = []
        for box_id, value in file_hashes.items():
            if document[box_id].checked:
                hash_list.append(bytes.fromhex(value))
        preimage = bytes().join(hash_list)
        commitment = sha256(sha256(preimage).digest()).digest()
        document['commitment'].value = commitment.hex()
    
    fragment_params = dict(_pair.split('=') for _pair in document.location.hash[1:].split('&'))
    try:
        bearer = fragment_params['access_token']
        get_file_list()
        
        document['attest'].bind('click', attest)
        document['verify'].bind('click', verify)
        document['create'].bind('click', create_mainstay_folder)
        document['fetch'].bind('click', fetch)
    except KeyError:
        pass
    
  #]]>
  </script>
 </head>
 <body onload="brython()">
  <form id="main">

   Login to Dropbox: <a href="https://www.dropbox.com/oauth2/authorize?client_id=1wgf9qlosdu2r6t&amp;response_type=token&amp;redirect_uri=http://localhost:5000/">[login]</a> <br/>

   Select files from Dropbox: <span id="dropbox_button_container"/> <br/>
   <table id="attest_file_table"> </table> <br/>

   <label class="interactive_input" for="commitment">commitment:</label> <span class="input_container"><input type="text" id="commitment" name="commitment"/></span> <br/>
   <label class="interactive_input" for="slot">slot:</label>             <span class="input_container"><input type="text" id="slot" name="slot" value="5"/></span> <br/>
   <label class="interactive_input" for="api_token">api token:</label>   <span class="input_container"><input type="text" id="api_token" name="api_token" value="8db965b9-62f2-49cf-b96e-edbf5caac7fb"/></span> <br/>
   <input type="button" id="attest" value="attest"/> <input type="button" id="verify" value="verify"/> <br/>
   <input type="button" id="create" value="create Mainstay folder"/> <input type="button" id="fetch" value="fetch"/> <br/>
  </form>
 </body>
</html>
