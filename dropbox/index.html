<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <meta charset="utf-8"/>
  <title>Mainstay to Dropbox</title>
  <link rel="stylesheet" type="text/css" href="style.css"/>
  <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="1wgf9qlosdu2r6t"/>
  <script type="text/javascript" src="https://brython.info/src/brython.js"/>
  <script type="text/javascript" src="https://brython.info/src/brython_stdlib.js"/>

  <script type="text/python">
  #<![CDATA[
    
    from browser import window, document, ajax
    from browser.html import maketag
    from hashlib import sha256
    
    tr = maketag('tr')
    td = maketag('td')
    progress = maketag('progress')
    label = maketag('label')
    
    attest_file_list = None
    downloads_pending = 0
    digest = {}
    
    def dropbox_files_accept(files, something):
        global attest_file_list, downloads_pending, digest

        document['dropbox_button_container'].clear()

        attest_file_list = files
        attest_file_table = document['attest_file_table']
        attest_file_table.clear()

        downloads_pending = len(files)
        digest = {}

        for n, f in enumerate(sorted(files, key=(lambda x: x.name))):
            download_name = 'download_' + str(n)
            progress_name = 'progress_' + str(n)
            attest_file_table <= tr(td(f.name) + td(label("downloads progress", **{'for':progress_name}) + progress(id=progress_name, value='0', max='100'), id=download_name))
            
            digest[f.name] = sha256()

            progress_callback = (lambda progress_name: (lambda src: download_progress(progress_name, src)))(progress_name)
            downloaded_callback = (lambda download_name, progress_name, file_name: (lambda src: downloaded(download_name, progress_name, file_name, src)))(download_name, progress_name, f.name)
            #interactive_callback = (lambda file_name: (lambda src: download_interactive(file_name, src)))(f.name)
            
            ajax.get(f.link, blocking=False, mode='binary', oncomplete=downloaded_callback, onprogress=progress_callback)
    
    def download_interactive(file_name, src):
        digest[file_name].update(src.read())
    
    def download_progress(progress_name, src):
        try:
            document[progress_name].value = src.loaded / src.total * 100
        except (AttributeError, ZeroDivisionError):
            pass
    
    def downloaded(download_name, progress_name, file_name, src):
        document[progress_name].value = 100
        def showhash():
            global downloads_pending
            digest[file_name].update(src.read())
            document[download_name].clear()
            digest[file_name] = digest[file_name].hexdigest()
            document[download_name] <= digest[file_name]
            downloads_pending -= 1
            if downloads_pending == 0:
                window.setTimeout(all_downloads_finished)
        window.setTimeout(showhash)
    
    def all_downloads_finished():
        preimage = bytes.fromhex(''.join([digest[_file_name] for _file_name in sorted(digest.keys())]))
        commitment = sha256(sha256(preimage).digest()).digest()
        document['commitment'].value = commitment.hex()
    
    def attest(event):
        if downloads_pending:
            window.alert("still downloading")
            return
        ajax.post('/attest', blocking=False, data={'commitment': document['commitment'].value, 'slot': document['slot'].value, 'api_token': document['api_token'].value}, oncomplete=attested)
    
    def attested(src):
        window.alert(src.read())
    
    def verify(event):
        if downloads_pending:
            window.alert("still downloading")
            return
        ajax.post('/verify', blocking=False, data={'commitment': document['commitment'].value, 'slot': document['slot'].value, 'api_token': document['api_token'].value}, oncomplete=attested)
    
    def verified(src):
        window.alert(src.read())
    
    dropbox_button_options = { 'success': dropbox_files_accept, 'linkType': 'direct', 'multiselect': True }
    dropbox_button = window.Dropbox.createChooseButton(dropbox_button_options)
    document.getElementById("dropbox_button_container").appendChild(dropbox_button)

    document['attest'].bind('click', attest)
    document['verify'].bind('click', verify)
    
  #]]>
  </script>
 </head>
 <body onload="brython()">
  <form id="main">

   Select files from Dropbox: <span id="dropbox_button_container"/> <br/>
   <table id="attest_file_table"> </table> <br/>

   <label class="interactive_input" for="commitment">commitment:</label> <span class="input_container"><input type="text" id="commitment" name="commitment"/></span> <br/>
   <label class="interactive_input" for="slot">slot:</label>             <span class="input_container"><input type="text" id="slot" name="slot" value="5"/></span> <br/>
   <label class="interactive_input" for="api_token">api token:</label>   <span class="input_container"><input type="text" id="api_token" name="api_token" value="8db965b9-62f2-49cf-b96e-edbf5caac7fb"/></span> <br/>
   <input type="button" id="attest" value="attest"/> <input type="button" id="verify" value="verify"/>
  </form>
 </body>
</html>
